<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Financeiro</title>
<style>
:root {
  --bg-color: #0f172a;
  --primary: #2563eb;
  --secondary: #1e293b;
  --card-bg: #ffffff;
  --text-color: #f1f5f9;
  --hover: #334155;
  --recebido: #16a34a;
  --receber: #ca8a04;
}
* { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }
body { display: flex; background: #f1f5f9; }

/* MENU LATERAL */
.sidebar {
  width: 240px; height: 100vh; background: var(--bg-color);
  color: var(--text-color); display: flex; flex-direction: column;
  padding: 20px; position: fixed; transition: transform 0.3s ease;
}
.sidebar h3 { text-align: center; margin-bottom: 30px; font-size: 1.3em; }
.sidebar a {
  display: block; padding: 12px 10px; margin-bottom: 5px; border-radius: 6px;
  font-weight: 500; color: var(--text-color); transition: 0.3s;
}
.sidebar a:hover { background: var(--hover); }

/* BOTÃƒO MENU MOBILE */
.menu-toggle {
  display: none; position: fixed; top: 15px; left: 15px;
  background: var(--primary); border: none; padding: 10px 15px;
  color: #fff; border-radius: 6px; font-size: 16px; cursor: pointer; z-index: 1001;
}

/* CONTEÃšDO PRINCIPAL */
.main { margin-left: 240px; padding: 30px; flex: 1; transition: margin-left 0.3s ease; }
.card { background: var(--card-bg); padding: 25px; border-radius: 14px; margin-bottom: 25px; box-shadow: 0 15px 30px rgba(0,0,0,0.05); }

.filtro { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
input, select { padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; flex: 1; min-width: 120px; }
button { padding: 10px 16px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; background: var(--primary); color: #fff; }
button:hover { background: #1e40af; }

/* RESUMO FINANCEIRO */
.resumo { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
.box {
  flex: 1; padding: 20px; border-radius: 12px; color: #fff;
  min-width: 150px;
}
.recebido { background: var(--recebido); }
.receber { background: var(--receber); }

/* CLIENTES E TABELAS */
.cliente { border: 1px solid #e5e7eb; border-radius: 8px; margin-top: 15px; padding: 15px; overflow-x: auto; }
.cliente h3 { margin-top: 0; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 400px; }
th, td { border: 1px solid #ccc; padding: 8px; font-size: 14px; text-align: left; }
th { background: #f1f5f9; }

/* RESPONSIVO */
@media(max-width: 768px) {
  .sidebar { transform: translateX(-260px); height: 100%; position: fixed; z-index: 1000; }
  .sidebar.show { transform: translateX(0); }
  .main { margin-left: 0; padding: 20px; }
  .menu-toggle { display: block; }
}
</style>
</head>

<body>

<!-- BOTÃƒO MENU MOBILE -->
<button class="menu-toggle" onclick="toggleMenu()">â˜° Menu</button>

<div class="sidebar" id="sidebar">
  <h3>ðŸ›  Sistema OS</h3>
  <a href="index.html">Entrada de Equipamento</a>
  <a href="clientes.html">Cadastro de Clientes</a>
  <a href="visualizar-os.html">Visualizar OS</a>
  <a href="financeiro.html">Financeiro</a>
  <a href="produtos.html">Produtos</a>
  <a href="backup.html">Backup / Restaurar</a>
</div>

<div class="main">

  <!-- FILTRO -->
  <div class="card filtro">
    <input type="date" id="dataInicio">
    <input type="date" id="dataFim">
    <button onclick="aplicarFiltro()">Filtrar</button>
    <button onclick="gerarPDF()">Gerar PDF</button>
  </div>

  <!-- RESUMO -->
  <div class="card resumo">
    <div class="box recebido">
      <h3>Total Recebido</h3>
      <h1 id="totalRecebido">R$ 0,00</h1>
    </div>
    <div class="box receber">
      <h3>Total a Receber</h3>
      <h1 id="totalReceber">R$ 0,00</h1>
    </div>
  </div>

  <!-- RELATÃ“RIO POR CLIENTE -->
  <div class="card">
    <h2>RelatÃ³rio por Cliente</h2>
    <div id="relatorioClientes"></div>
  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBSQrG5bdCGC_6kUQxccgJxz2gtLiB2Kb4",
  authDomain: "sistema-os-1284b.firebaseapp.com",
  projectId: "sistema-os-1284b",
  storageBucket: "sistema-os-1284b.appspot.com",
  messagingSenderId: "1032102605721",
  appId: "1:1032102605721:web:7eba5fc6e4eb9fc17ad908"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const osCollection = collection(db, "os");

let todasOS = [];

async function carregar() {
  todasOS = [];
  const snap = await getDocs(osCollection);
  snap.forEach(d => {
    const os = d.data();
    os.data = os.data?.seconds
      ? new Date(os.data.seconds * 1000)
      : new Date();
    todasOS.push(os);
  });
  render(todasOS);
}

function render(lista) {
  let totalRecebido = 0;
  let totalReceber = 0;
  const clientes = {};

  lista.forEach(os => {
    const valor = Number(os.valor) || 0;
    if(!clientes[os.cliente]) clientes[os.cliente] = { recebido:0, receber:0, ordens:[] };
    if(os.status === "ConcluÃ­do") {
      clientes[os.cliente].recebido += valor; totalRecebido += valor;
    } else {
      clientes[os.cliente].receber += valor; totalReceber += valor;
    }
    clientes[os.cliente].ordens.push({ ...os, valor });
  });

  document.getElementById("totalRecebido").innerText = `R$ ${totalRecebido.toFixed(2)}`;
  document.getElementById("totalReceber").innerText = `R$ ${totalReceber.toFixed(2)}`;

  const container = document.getElementById("relatorioClientes");
  container.innerHTML = "";

  Object.keys(clientes).forEach(nome => {
    const c = clientes[nome];
    container.innerHTML += `
      <div class="cliente">
        <h3>${nome}</h3>
        <p><b>Recebido:</b> R$ ${c.recebido.toFixed(2)} |
           <b>A receber:</b> R$ ${c.receber.toFixed(2)}</p>
        <table>
          <thead>
            <tr>
              <th>Data</th><th>OS</th><th>Status</th><th>Valor</th>
            </tr>
          </thead>
          <tbody>
            ${c.ordens.map(o => `
              <tr>
                <td>${o.data.toLocaleDateString()}</td>
                <td>${o.osnum}</td>
                <td>${o.status}</td>
                <td>R$ ${o.valor.toFixed(2)}</td>
              </tr>`).join("")}
          </tbody>
        </table>
      </div>`;
  });
}

function aplicarFiltro() {
  const i = document.getElementById("dataInicio").value;
  const f = document.getElementById("dataFim").value;
  if(!i || !f) return alert("Selecione o perÃ­odo");
  const di = new Date(i);
  const df = new Date(f + "T23:59:59");
  render(todasOS.filter(o => o.data >= di && o.data <= df));
}

function gerarPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  let y = 15;
  pdf.setFontSize(16);
  pdf.text("RELATÃ“RIO FINANCEIRO POR CLIENTE", 14, y); y+=8;
  pdf.setFontSize(10);
  pdf.text(`Emitido em: ${new Date().toLocaleDateString()}`, 14, y); y+=10;

  document.querySelectorAll(".cliente").forEach(div => {
    const linhas = div.innerText.split("\n");
    linhas.forEach(l => {
      if(y > 280){ pdf.addPage(); y=15; }
      pdf.text(l, 14, y); y+=6;
    });
    y+=6;
  });
  pdf.save("relatorio-financeiro-clientes.pdf");
}

// MENU MOBILE
function toggleMenu() { document.getElementById('sidebar').classList.toggle('show'); }

window.aplicarFiltro = aplicarFiltro;
window.gerarPDF = gerarPDF;

carregar();
</script>
</body>
</html>
