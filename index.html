<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-firestore.js";

// Config do Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBSQrG5bdCGC_6kUQxccgJxz2gtLiB2Kb4",
  authDomain: "sistema-os-1284b.firebaseapp.com",
  projectId: "sistema-os-1284b",
  storageBucket: "sistema-os-1284b.firebasestorage.app",
  messagingSenderId: "1032102605721",
  appId: "1:1032102605721:web:7eba5fc6e4eb9fc17ad908"
};

// Inicializa Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Coleções
const osCollection = collection(db, "os");
const clientesCollection = collection(db, "clientes");

// Carregar clientes no select
async function carregarClientes() {
  const snapshot = await getDocs(clientesCollection);
  const select = document.getElementById("clienteSelect");
  select.innerHTML = '<option value="">--Selecione--</option>';

  snapshot.forEach(doc => {
    const cliente = doc.data();
    const option = document.createElement("option");
    option.value = cliente.nome;
    option.textContent = cliente.nome;
    select.appendChild(option);
  });
}

// Gerar próximo número de OS
async function gerarOS() {
  const snapshot = await getDocs(osCollection);
  if(snapshot.empty) return 1000;
  const numeros = snapshot.docs.map(doc => parseInt(doc.data().osnum));
  return Math.max(...numeros) + 1;
}

// Salvar OS
async function salvarOS() {
  let clienteSelect = document.getElementById("clienteSelect").value;
  let novoCliente = document.getElementById("novoCliente").value.trim();

  if(!clienteSelect && !novoCliente) {
    alert("Informe um cliente!");
    return;
  }

  let clienteNome = clienteSelect || novoCliente;
  let telefone = document.getElementById("telefone").value;
  let endereco = document.getElementById("endereco").value;
  let status = document.getElementById("status").value;
  let descricao = document.getElementById("descricao").value;
  let valor = parseFloat(document.getElementById("valor").value) || 150; // valor padrão 150

  // Se for novo cliente, salva na coleção de clientes
  if(novoCliente) {
    try {
      await addDoc(clientesCollection, { nome: clienteNome, telefone, endereco });
    } catch(e) {
      console.error("Erro ao salvar cliente: ", e);
      alert("Erro ao salvar cliente. Veja o console.");
      return;
    }
  }

  // Salvar OS
  let osnum = await gerarOS();
  try {
    await addDoc(osCollection, {
      osnum,
      cliente: clienteNome,
      telefone,
      endereco,
      status,
      descricao,
      valor
    });

    alert("OS salva com sucesso!");

    // Limpar formulário
    document.getElementById("novoCliente").value = "";
    document.getElementById("telefone").value = "";
    document.getElementById("endereco").value = "";
    document.getElementById("descricao").value = "";
    document.getElementById("valor").value = "";
    document.getElementById("status").value = "Pendente";
    document.getElementById("clienteSelect").value = "";

    carregarClientes();
  } catch(e) {
    console.error("Erro ao salvar OS: ", e);
    alert("Erro ao salvar OS. Veja o console.");
  }
}

// Inicializa clientes
carregarClientes();

// Expor função para o botão
window.salvarOS = salvarOS;
</script>
