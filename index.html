<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema OS - Entrada</title>

<style>
body { margin: 0; font-family: Arial; display: flex; background: #f1f5f9; }
.sidebar {
  width: 240px; background: #0f172a; color: #fff;
  padding: 20px; height: 100vh; position: fixed;
}
.sidebar a {
  color: #fff; text-decoration: none;
  display: block; padding: 10px;
}
.sidebar a:hover { background: #334155; border-radius: 6px; }

.main { margin-left: 240px; padding: 30px; width: 100%; }

.card {
  background: #fff; padding: 25px;
  border-radius: 14px; max-width: 700px;
}

input, select, textarea {
  width: 100%; padding: 10px;
  margin-top: 10px; border-radius: 8px;
  border: 1px solid #cbd5e1;
}

button {
  margin-top: 15px; padding: 12px;
  border: none; border-radius: 8px;
  background: #2563eb; color: #fff;
  font-weight: bold; cursor: pointer;
}
button:hover { background: #1e40af; }
</style>
</head>

<body>

<div class="sidebar">
  <h3>ðŸ›  Sistema OS</h3>
  <a href="index.html">Entrada de Equipamento</a>
  <a href="clientes.html">Cadastro de Clientes</a>
  <a href="visualizar-os.html">Visualizar OS</a>
  <a href="financeiro.html">Financeiro</a>
  <a href="produtos.html">Produtos</a>
  <a href="backup.html">Backup / Restaurar</a>
</div>

<div class="main">
  <div class="card">
    <h2>Cadastro de Ordem de ServiÃ§o</h2>

    <label>Cliente existente</label>
    <select id="clienteSelect">
      <option value="">-- Selecionar --</option>
    </select>

    <label>Ou novo cliente</label>
    <input id="novoCliente" placeholder="Nome do cliente">
    <input id="telefone" placeholder="Telefone">
    <input id="endereco" placeholder="EndereÃ§o">

    <label>Status</label>
    <select id="status">
      <option>Pendente</option>
      <option>Em bancada</option>
      <option>OrÃ§amento pronto</option>
      <option>ConcluÃ­do</option>
    </select>

    <textarea id="descricao" placeholder="DescriÃ§Ã£o do serviÃ§o"></textarea>
    <input id="valor" type="number" value="150">

    <button onclick="salvarOS()">Salvar Ordem de ServiÃ§o</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, query, where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBSQrG5bdCGC_6kUQxccgJxz2gtLiB2Kb4",
  authDomain: "sistema-os-1284b.firebaseapp.com",
  projectId: "sistema-os-1284b",
  storageBucket: "sistema-os-1284b.appspot.com",
  messagingSenderId: "1032102605721",
  appId: "1:1032102605721:web:7eba5fc6e4eb9fc17ad908"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const clientesRef = collection(db, "clientes");
const osRef = collection(db, "os");

// ðŸ”¹ Carregar clientes
async function carregarClientes() {
  const snap = await getDocs(clientesRef);
  const select = document.getElementById("clienteSelect");
  select.innerHTML = `<option value="">-- Selecionar --</option>`;

  snap.forEach(d => {
    const c = d.data();
    const opt = document.createElement("option");
    opt.value = c.nome;
    opt.textContent = c.nome;
    select.appendChild(opt);
  });
}

// ðŸ”¹ Gerar nÃºmero da OS
async function gerarOS() {
  const snap = await getDocs(osRef);
  if(snap.empty) return 1000;
  const nums = snap.docs.map(d => Number(d.data().osnum || 0));
  return Math.max(...nums) + 1;
}

// ðŸ”¹ Salvar OS
async function salvarOS() {
  const clienteSelect = document.getElementById("clienteSelect").value;
  const novoCliente = document.getElementById("novoCliente").value.trim();
  const cliente = clienteSelect || novoCliente;

  if(!cliente) return alert("Informe o cliente");

  const telefone = document.getElementById("telefone").value;
  const endereco = document.getElementById("endereco").value;
  const status = document.getElementById("status").value;
  const descricao = document.getElementById("descricao").value;
  const valor = Number(document.getElementById("valor").value) || 150;

  // ðŸ‘‰ cadastra cliente novo se nÃ£o existir
  if(novoCliente) {
    const q = query(clientesRef, where("nome", "==", novoCliente));
    const existe = await getDocs(q);
    if(existe.empty) {
      await addDoc(clientesRef, { nome: novoCliente, telefone, endereco });
    }
  }

  const osnum = await gerarOS();
  const financeiroStatus = status === "ConcluÃ­do" ? "recebido" : "pendente";

  await addDoc(osRef, {
    osnum,
    cliente,
    telefone,
    endereco,
    status,
    descricao,
    valor,
    financeiroStatus,
    data: new Date()
  });

  alert("Ordem de ServiÃ§o salva com sucesso!");

  document.querySelectorAll("input, textarea").forEach(el => el.value = "");
  document.getElementById("valor").value = 150;
  document.getElementById("status").value = "Pendente";
  document.getElementById("clienteSelect").value = "";

  carregarClientes();
}

window.salvarOS = salvarOS;
carregarClientes();
</script>

</body>
</html>

