<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Visualizar Ordens de Servi√ßo</title>
<style>
:root {
  --bg-color: #f1f5f9;
  --sidebar-bg: #0f172a;
  --primary: #2563eb;
  --hover: #334155;
  --card-bg: #fff;
  --text-color: #f1f5f9;
  --button-bg: #2563eb;
  --button-hover: #1e40af;
}
* { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }

/* MENU LATERAL */
.sidebar {
  width: 240px; height: 100vh; background: var(--sidebar-bg);
  color: var(--text-color); display: flex; flex-direction: column;
  padding: 20px; position: fixed; transition: transform 0.3s ease;
}
.sidebar h3 { text-align: center; margin-bottom: 30px; font-size: 1.3em; }
.sidebar a {
  display: block; padding: 12px; margin-bottom: 5px;
  color: var(--text-color); text-decoration: none; border-radius: 6px; font-weight: 500;
}
.sidebar a:hover { background: var(--hover); }

/* BOT√ÉO MENU MOBILE */
.menu-toggle {
  display: none; position: fixed; top: 15px; left: 15px;
  background: var(--primary); border: none; padding: 10px 15px;
  color: #fff; border-radius: 6px; font-size: 16px; cursor: pointer; z-index: 1001;
}

/* CONTE√öDO PRINCIPAL */
.main { margin-left: 240px; padding: 30px; flex: 1; transition: margin-left 0.3s ease; }
.card { background: var(--card-bg); padding: 25px; border-radius: 14px; margin-bottom: 25px; box-shadow: 0 15px 30px rgba(0,0,0,0.05); }

/* T√çTULOS */
h3 { margin-top: 0; border-left: 5px solid var(--primary); padding-left: 10px; }

/* INPUTS E BOT√ïES */
input, select, textarea, button {
  width: 100%; padding: 10px; margin-top: 10px;
  border-radius: 8px; border: 1px solid #cbd5e1;
}
button { background: var(--button-bg); color: #fff; font-weight: bold; cursor: pointer; }
button:hover { background: var(--button-hover); }

/* TABELA */
table { width: 100%; border-collapse: collapse; margin-top: 20px; min-width: 400px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
th { background: #f1f5f9; }
textarea { resize: vertical; }

/* RESPONSIVO */
@media(max-width:768px){
  .sidebar { transform: translateX(-260px); height: 100%; position: fixed; z-index: 1000; }
  .sidebar.show { transform: translateX(0); }
  .main { margin-left: 0; padding: 20px; }
  .menu-toggle { display: block; }
}
</style>
</head>
<body>

<button class="menu-toggle" onclick="toggleMenu()">‚ò∞ Menu</button>

<div class="sidebar" id="sidebar">
  <h3>üõ† Sistema OS</h3>
  <a href="index.html">Entrada de Equipamento</a>
  <a href="clientes.html">Cadastro de Clientes</a>
  <a href="visualizar-os.html">Visualizar OS</a>
  <a href="financeiro.html">Financeiro</a>
  <a href="produtos.html">Produtos</a>
  <a href="backup.html">Backup / Restaurar</a>
</div>

<div class="main">

  <div class="card">
    <h3>Ordens em Aberto</h3>
    <div style="overflow-x:auto">
      <table>
        <thead>
          <tr>
            <th>OS</th>
            <th>Cliente</th>
            <th>Descri√ß√£o</th>
            <th>Status</th>
            <th>Valor</th>
            <th>Observa√ß√£o</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="listaAbertas"></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h3>Ordens Conclu√≠das</h3>
    <div style="overflow-x:auto">
      <table>
        <thead>
          <tr>
            <th>OS</th>
            <th>Cliente</th>
            <th>Valor</th>
            <th>PDF</th>
          </tr>
        </thead>
        <tbody id="listaConcluidas"></tbody>
      </table>
    </div>
  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBSQrG5bdCGC_6kUQxccgJxz2gtLiB2Kb4",
  authDomain: "sistema-os-1284b.firebaseapp.com",
  projectId: "sistema-os-1284b",
  storageBucket: "sistema-os-1284b.appspot.com",
  messagingSenderId: "1032102605721",
  appId: "1:1032102605721:web:7eba5fc6e4eb9fc17ad908"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const osRef = collection(db, "os");

async function carregar() {
  const abertas = document.getElementById("listaAbertas");
  const concluidas = document.getElementById("listaConcluidas");
  abertas.innerHTML = "";
  concluidas.innerHTML = "";

  const snap = await getDocs(osRef);
  snap.forEach(d => {
    const os = d.data();
    const id = d.id;
    const valor = Number(os.valor) || 150;

    if(os.status === "Conclu√≠do") {
      concluidas.innerHTML += `
        <tr>
          <td>${os.osnum}</td>
          <td>${os.cliente}</td>
          <td>R$ ${valor.toFixed(2)}</td>
          <td>
            <button onclick='pdfOS(${JSON.stringify(os)})'>OS</button>
            <button onclick='recibo(${JSON.stringify(os)})'>Recibo</button>
          </td>
        </tr>
      `;
    } else {
      abertas.innerHTML += `
        <tr>
          <td>${os.osnum}</td>
          <td>${os.cliente}</td>
          <td><textarea id="d-${id}">${os.descricao || ""}</textarea></td>
          <td>
            <select id="s-${id}">
              <option ${os.status=="Pendente"?"selected":""}>Pendente</option>
              <option ${os.status=="Em bancada"?"selected":""}>Em bancada</option>
              <option ${os.status=="Or√ßamento pronto"?"selected":""}>Or√ßamento pronto</option>
              <option ${os.status=="Conclu√≠do"?"selected":""}>Conclu√≠do</option>
            </select>
          </td>
          <td><input type="number" id="v-${id}" value="${valor}"></td>
          <td><textarea id="o-${id}">${os.observacao || ""}</textarea></td>
          <td>
            <button onclick="salvar('${id}')">Salvar</button>
            <button onclick='pdfOS(${JSON.stringify(os)})'>PDF OS</button>
          </td>
        </tr>
      `;
    }
  });
}

async function salvar(id) {
  const status = document.getElementById(`s-${id}`).value;

  await updateDoc(doc(db, "os", id), {
    descricao: document.getElementById(`d-${id}`).value,
    observacao: document.getElementById(`o-${id}`).value,
    valor: Number(document.getElementById(`v-${id}`).value),
    status,
    financeiroStatus: status === "Conclu√≠do" ? "recebido" : "pendente"
  });

  carregar();
}

/* PDF OS */
function pdfOS(os) {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  let y = 15;
  pdf.setFontSize(14); pdf.text("ORDEM DE SERVI√áO", 65, y); y+=8;
  pdf.setFontSize(10);
  pdf.text(`OS N¬∫: ${os.osnum}`, 14, y);
  pdf.text(`Data: ${new Date().toLocaleDateString()}`, 140, y); y+=6;
  pdf.text(`Cliente: ${os.cliente}`, 14, y); y+=6;
  pdf.text(`Telefone: ${os.telefone||""}`,14,y); y+=6;
  pdf.text(`Status: ${os.status}`,14,y); y+=6;
  pdf.text(`Valor: R$ ${(os.valor||150).toFixed(2)}`,14,y); y+=8;
  pdf.text("Descri√ß√£o:",14,y); y+=6; pdf.text(os.descricao||"-",14,y); y+=8;
  pdf.text("Observa√ß√µes:",14,y); y+=6; pdf.text(os.observacao||"-",14,y); y+=12;
  pdf.text("Assinatura do Cliente:",14,y); pdf.line(60,y,150,y);
  pdf.save(`OS-${os.osnum}.pdf`);
}

/* RECIBO */
function recibo(os){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  let y=20;
  pdf.setFontSize(14); pdf.text("RECIBO",95,y); y+=10;
  pdf.setFontSize(10);
  pdf.text(`Recebi de: ${os.cliente}`,14,y); y+=6;
  pdf.text(`Valor: R$ ${(os.valor||150).toFixed(2)}`,14,y); y+=6;
  pdf.text(`Referente √† OS N¬∫ ${os.osnum}`,14,y); y+=6;
  pdf.text("Servi√ßo prestado conforme combinado.",14,y); y+=10;
  pdf.text(`Data: ${new Date().toLocaleDateString()}`,14,y); y+=12;
  pdf.text("Assinatura:",14,y); pdf.line(40,y,120,y);
  pdf.save(`Recibo-OS-${os.osnum}.pdf`);
}

window.salvar=salvar;
window.pdfOS=pdfOS;
window.recibo=recibo;
carregar();

// MENU MOBILE
function toggleMenu(){ document.getElementById('sidebar').classList.toggle('show'); }

</script>
</body>
</html>
