<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Visualizar Ordens de Servi√ßo</title>

<style>
body { margin: 0; font-family: Arial; display: flex; background: #f1f5f9; }
.sidebar {
  width: 240px; background: #0f172a; color: #fff;
  padding: 20px; height: 100vh; position: fixed;
}
.sidebar a { color: #fff; text-decoration: none; display: block; padding: 10px; }
.sidebar a:hover { background: #334155; border-radius: 6px; }

.main { margin-left: 240px; padding: 30px; width: 100%; }

.card {
  background: #fff; padding: 20px;
  border-radius: 12px; margin-bottom: 30px;
}

table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 8px; }

input, textarea, select {
  width: 100%; padding: 6px;
}

button {
  background: #2563eb; color: #fff;
  border: none; padding: 6px 10px;
  border-radius: 6px; cursor: pointer;
}
button:hover { background: #1e40af; }

.search { display: flex; gap: 10px; margin-bottom: 10px; }
</style>
</head>

<body>

<div class="sidebar">
  <h3>üõ† Sistema OS</h3>
  <a href="index.html">Entrada de Equipamento</a>
  <a href="clientes.html">Cadastro de Clientes</a>
  <a href="visualizar-os.html">Visualizar OS</a>
  <a href="financeiro.html">Financeiro</a>
  <a href="produtos.html">Produtos</a>
  <a href="backup.html">Backup / Restaurar</a>
</div>

<div class="main">

  <!-- ORDENS ATIVAS -->
  <div class="card">
    <h2>Ordens em Aberto</h2>

    <div class="search">
      <input id="busca" placeholder="Buscar por OS ou Cliente">
      <button onclick="filtrar()">Pesquisar</button>
      <button onclick="carregarOS()">Limpar</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>OS</th>
          <th>Cliente</th>
          <th>Descri√ß√£o</th>
          <th>Valor</th>
          <th>Status</th>
          <th>Observa√ß√£o</th>
          <th>A√ß√£o</th>
        </tr>
      </thead>
      <tbody id="listaAbertas"></tbody>
    </table>
  </div>

  <!-- ORDENS CONCLU√çDAS -->
  <div class="card">
    <h2>Ordens Conclu√≠das</h2>
    <table>
      <thead>
        <tr>
          <th>OS</th>
          <th>Cliente</th>
          <th>Valor</th>
          <th>Observa√ß√£o</th>
        </tr>
      </thead>
      <tbody id="listaConcluidas"></tbody>
    </table>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBSQrG5bdCGC_6kUQxccgJxz2gtLiB2Kb4",
  authDomain: "sistema-os-1284b.firebaseapp.com",
  projectId: "sistema-os-1284b",
  storageBucket: "sistema-os-1284b.appspot.com",
  messagingSenderId: "1032102605721",
  appId: "1:1032102605721:web:7eba5fc6e4eb9fc17ad908"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const osCollection = collection(db, "os");

let todasOS = [];

// üîπ Carregar OS
async function carregarOS() {
  todasOS = [];
  const abertas = document.getElementById("listaAbertas");
  const concluidas = document.getElementById("listaConcluidas");
  abertas.innerHTML = "";
  concluidas.innerHTML = "";

  const snap = await getDocs(osCollection);
  snap.forEach(d => todasOS.push({ id: d.id, ...d.data() }));

  render(todasOS);
}

// üîπ Renderizar
function render(lista) {
  const abertas = document.getElementById("listaAbertas");
  const concluidas = document.getElementById("listaConcluidas");
  abertas.innerHTML = "";
  concluidas.innerHTML = "";

  lista.forEach(os => {
    if(os.status === "Conclu√≠do") {
      concluidas.innerHTML += `
        <tr>
          <td>${os.osnum}</td>
          <td>${os.cliente}</td>
          <td>R$ ${(os.valor || 150).toFixed(2)}</td>
          <td>${os.observacao || ""}</td>
        </tr>
      `;
    } else {
      abertas.innerHTML += `
        <tr>
          <td>${os.osnum}</td>
          <td><input id="c-${os.id}" value="${os.cliente}"></td>
          <td><textarea id="d-${os.id}">${os.descricao || ""}</textarea></td>
          <td><input type="number" id="v-${os.id}" value="${os.valor || 150}"></td>
          <td>
            <select id="s-${os.id}">
              <option ${os.status=="Pendente"?"selected":""}>Pendente</option>
              <option ${os.status=="Em bancada"?"selected":""}>Em bancada</option>
              <option ${os.status=="Or√ßamento pronto"?"selected":""}>Or√ßamento pronto</option>
              <option ${os.status=="Conclu√≠do"?"selected":""}>Conclu√≠do</option>
            </select>
          </td>
          <td><textarea id="o-${os.id}">${os.observacao || ""}</textarea></td>
          <td><button onclick="salvar('${os.id}')">Salvar</button></td>
        </tr>
      `;
    }
  });
}

// üîπ Salvar edi√ß√£o
async function salvar(id) {
  const status = document.getElementById(`s-${id}`).value;
  const financeiroStatus = status === "Conclu√≠do" ? "recebido" : "pendente";

  await updateDoc(doc(db, "os", id), {
    cliente: document.getElementById(`c-${id}`).value,
    descricao: document.getElementById(`d-${id}`).value,
    valor: Number(document.getElementById(`v-${id}`).value),
    status,
    observacao: document.getElementById(`o-${id}`).value,
    financeiroStatus
  });

  carregarOS();
}

// üîπ Pesquisa
function filtrar() {
  const termo = document.getElementById("busca").value.toLowerCase();
  render(todasOS.filter(os =>
    os.cliente.toLowerCase().includes(termo) ||
    String(os.osnum).includes(termo)
  ));
}

window.salvar = salvar;
window.filtrar = filtrar;

carregarOS();
</script>

</body>
</html>

