<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Visualizar Ordens de Servi√ßo</title>

<style>
:root {
  --bg: #0f172a;
  --primary: #2563eb;
  --card: #ffffff;
}
* { box-sizing: border-box; }
body { margin: 0; font-family: Arial; display: flex; background: #f1f5f9; }
.sidebar {
  width: 240px; background: var(--bg); color: #fff;
  padding: 20px; position: fixed; height: 100vh;
}
.sidebar a {
  display: block; color: #fff; text-decoration: none;
  padding: 10px; border-radius: 6px; margin-bottom: 8px;
}
.sidebar a:hover { background: #334155; }
.main { margin-left: 240px; padding: 30px; width: 100%; }

.card {
  background: var(--card); padding: 20px;
  border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,.1);
}

table { width: 100%; border-collapse: collapse; margin-top: 15px; }
th, td { border: 1px solid #ccc; padding: 8px; }
input, select, textarea {
  width: 100%; padding: 6px; margin-top: 5px;
}
button {
  padding: 6px 10px; border: none;
  background: var(--primary); color: #fff;
  border-radius: 6px; cursor: pointer;
}
button:hover { background: #1e40af; }

.search {
  display: flex; gap: 10px; margin-bottom: 10px;
}
</style>
</head>

<body>

<div class="sidebar">
  <h3>üõ† Sistema OS</h3>
  <a href="index.html">Entrada</a>
  <a href="clientes.html">Clientes</a>
  <a href="visualizar-os.html">Visualizar OS</a>
  <a href="financeiro.html">Financeiro</a>
</div>

<div class="main">
  <div class="card">
    <h2>Ordens de Servi√ßo</h2>

    <div class="search">
      <input id="busca" placeholder="Buscar por OS ou Cliente">
      <button onclick="filtrar()">Pesquisar</button>
      <button onclick="carregarOS()">Limpar</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>OS</th>
          <th>Cliente</th>
          <th>Descri√ß√£o</th>
          <th>Valor</th>
          <th>Status</th>
          <th>Observa√ß√£o</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="listaOS"></tbody>
    </table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBSQrG5bdCGC_6kUQxccgJxz2gtLiB2Kb4",
  authDomain: "sistema-os-1284b.firebaseapp.com",
  projectId: "sistema-os-1284b",
  storageBucket: "sistema-os-1284b.appspot.com",
  messagingSenderId: "1032102605721",
  appId: "1:1032102605721:web:7eba5fc6e4eb9fc17ad908"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const osCollection = collection(db, "os");

let todasOS = [];

// üîπ Carregar OS
async function carregarOS() {
  const tbody = document.getElementById("listaOS");
  tbody.innerHTML = "";
  todasOS = [];

  const snap = await getDocs(osCollection);
  snap.forEach(d => {
    const os = d.data();
    todasOS.push({ id: d.id, ...os });
  });

  render(todasOS);
}

// üîπ Renderizar tabela
function render(lista) {
  const tbody = document.getElementById("listaOS");
  tbody.innerHTML = "";

  lista.forEach(os => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${os.osnum}</td>
      <td><input value="${os.cliente}" id="c-${os.id}"></td>
      <td><textarea id="d-${os.id}">${os.descricao || ""}</textarea></td>
      <td><input type="number" value="${os.valor || 150}" id="v-${os.id}"></td>
      <td>
        <select id="s-${os.id}">
          <option ${os.status=="Pendente"?"selected":""}>Pendente</option>
          <option ${os.status=="Em bancada"?"selected":""}>Em bancada</option>
          <option ${os.status=="Or√ßamento pronto"?"selected":""}>Or√ßamento pronto</option>
          <option ${os.status=="Conclu√≠do"?"selected":""}>Conclu√≠do</option>
        </select>
      </td>
      <td><textarea id="o-${os.id}">${os.observacao || ""}</textarea></td>
      <td><button onclick="salvar('${os.id}')">Salvar</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// üîπ Salvar edi√ß√£o
async function salvar(id) {
  try {
    await updateDoc(doc(db, "os", id), {
      cliente: document.getElementById(`c-${id}`).value,
      descricao: document.getElementById(`d-${id}`).value,
      valor: Number(document.getElementById(`v-${id}`).value),
      status: document.getElementById(`s-${id}`).value,
      observacao: document.getElementById(`o-${id}`).value
    });
    alert("OS atualizada!");
  } catch(e) {
    alert("Erro ao salvar");
    console.error(e);
  }
}

// üîπ Pesquisa
function filtrar() {
  const termo = document.getElementById("busca").value.toLowerCase();
  const filtrado = todasOS.filter(os =>
    os.cliente.toLowerCase().includes(termo) ||
    String(os.osnum).includes(termo)
  );
  render(filtrado);
}

window.salvar = salvar;
window.filtrar = filtrar;

carregarOS();
</script>

</body>
</html>
