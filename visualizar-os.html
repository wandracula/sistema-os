<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Ordens de Servi√ßo</title>

<style>
body { margin: 0; font-family: Arial; display: flex; background: #f1f5f9; }
.sidebar {
  width: 240px; background: #0f172a; color: #fff;
  padding: 20px; height: 100vh; position: fixed;
}
.sidebar a {
  color: #fff; text-decoration: none;
  display: block; padding: 12px;
  border-radius: 6px;
}
.sidebar a:hover { background: #334155; }

.main { margin-left: 240px; padding: 30px; width: 100%; }

.card {
  background: #fff; padding: 20px;
  border-radius: 12px; margin-bottom: 20px;
}

table { width: 100%; border-collapse: collapse; }
th, td { border: 1px solid #ccc; padding: 6px; font-size: 14px; }

input, textarea, select {
  width: 100%; padding: 6px;
}

button {
  background: #2563eb; color: #fff;
  border: none; padding: 6px 10px;
  border-radius: 6px; cursor: pointer;
  margin-bottom: 4px;
}
button:hover { background: #1e40af; }
</style>
</head>

<body>

<div class="sidebar">
  <h3>üõ† Sistema OS</h3>
  <a href="index.html">Entrada de Equipamento</a>
  <a href="clientes.html">Cadastro de Clientes</a>
  <a href="visualizar-os.html">Visualizar OS</a>
  <a href="financeiro.html">Financeiro</a>
  <a href="produtos.html">Produtos</a>
  <a href="backup.html">Backup / Restaurar</a>
</div>

<div class="main">

  <div class="card">
    <h2>Ordens em Aberto</h2>
    <table>
      <thead>
        <tr>
          <th>OS</th>
          <th>Cliente</th>
          <th>Descri√ß√£o</th>
          <th>Status</th>
          <th>Valor</th>
          <th>Observa√ß√£o</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="listaAbertas"></tbody>
    </table>
  </div>

  <div class="card">
    <h2>Ordens Conclu√≠das</h2>
    <table>
      <thead>
        <tr>
          <th>OS</th>
          <th>Cliente</th>
          <th>Valor</th>
          <th>PDF</th>
        </tr>
      </thead>
      <tbody id="listaConcluidas"></tbody>
    </table>
  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBSQrG5bdCGC_6kUQxccgJxz2gtLiB2Kb4",
  authDomain: "sistema-os-1284b.firebaseapp.com",
  projectId: "sistema-os-1284b",
  storageBucket: "sistema-os-1284b.appspot.com",
  messagingSenderId: "1032102605721",
  appId: "1:1032102605721:web:7eba5fc6e4eb9fc17ad908"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const osRef = collection(db, "os");

async function carregar() {
  const abertas = document.getElementById("listaAbertas");
  const concluidas = document.getElementById("listaConcluidas");
  abertas.innerHTML = "";
  concluidas.innerHTML = "";

  const snap = await getDocs(osRef);
  snap.forEach(d => {
    const os = d.data();
    const id = d.id;
    const valor = Number(os.valor) || 150;

    if(os.status === "Conclu√≠do") {
      concluidas.innerHTML += `
        <tr>
          <td>${os.osnum}</td>
          <td>${os.cliente}</td>
          <td>R$ ${valor.toFixed(2)}</td>
          <td>
            <button onclick='pdfOS(${JSON.stringify(os)})'>OS</button>
            <button onclick='recibo(${JSON.stringify(os)})'>Recibo</button>
          </td>
        </tr>
      `;
    } else {
      abertas.innerHTML += `
        <tr>
          <td>${os.osnum}</td>
          <td>${os.cliente}</td>
          <td><textarea id="d-${id}">${os.descricao || ""}</textarea></td>
          <td>
            <select id="s-${id}">
              <option ${os.status=="Pendente"?"selected":""}>Pendente</option>
              <option ${os.status=="Em bancada"?"selected":""}>Em bancada</option>
              <option ${os.status=="Or√ßamento pronto"?"selected":""}>Or√ßamento pronto</option>
              <option ${os.status=="Conclu√≠do"?"selected":""}>Conclu√≠do</option>
            </select>
          </td>
          <td><input type="number" id="v-${id}" value="${valor}"></td>
          <td><textarea id="o-${id}">${os.observacao || ""}</textarea></td>
          <td>
            <button onclick="salvar('${id}')">Salvar</button>
            <button onclick='pdfOS(${JSON.stringify(os)})'>PDF OS</button>
          </td>
        </tr>
      `;
    }
  });
}

async function salvar(id) {
  const status = document.getElementById(`s-${id}`).value;

  await updateDoc(doc(db, "os", id), {
    descricao: document.getElementById(`d-${id}`).value,
    observacao: document.getElementById(`o-${id}`).value,
    valor: Number(document.getElementById(`v-${id}`).value),
    status,
    financeiroStatus: status === "Conclu√≠do" ? "recebido" : "pendente"
  });

  carregar();
}

/* ===== PDF ORDEM (COMPACTO) ===== */
function pdfOS(os) {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  let y = 15;
  pdf.setFontSize(14);
  pdf.text("ORDEM DE SERVI√áO", 65, y);
  y += 8;

  pdf.setFontSize(10);
  pdf.text(`OS N¬∫: ${os.osnum}`, 14, y);
  pdf.text(`Data: ${new Date().toLocaleDateString()}`, 140, y);
  y += 6;

  pdf.text(`Cliente: ${os.cliente}`, 14, y); y += 6;
  pdf.text(`Telefone: ${os.telefone || ""}`, 14, y); y += 6;
  pdf.text(`Status: ${os.status}`, 14, y); y += 6;
  pdf.text(`Valor: R$ ${(os.valor || 150).toFixed(2)}`, 14, y); y += 8;

  pdf.text("Descri√ß√£o:", 14, y); y += 6;
  pdf.text(os.descricao || "-", 14, y); y += 8;

  pdf.text("Observa√ß√µes:", 14, y); y += 6;
  pdf.text(os.observacao || "-", 14, y); y += 12;

  pdf.text("Assinatura do Cliente:", 14, y);
  pdf.line(60, y, 150, y);

  pdf.save(`OS-${os.osnum}.pdf`);
}

/* ===== RECIBO (MEIA FOLHA A4) ===== */
function recibo(os) {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  let y = 20;
  pdf.setFontSize(14);
  pdf.text("RECIBO", 95, y);
  y += 10;

  pdf.setFontSize(10);
  pdf.text(`Recebi de: ${os.cliente}`, 14, y); y += 6;
  pdf.text(`Valor: R$ ${(os.valor || 150).toFixed(2)}`, 14, y); y += 6;
  pdf.text(`Referente √† OS N¬∫ ${os.osnum}`, 14, y); y += 6;

  pdf.text("Servi√ßo prestado conforme combinado.", 14, y); y += 10;
  pdf.text(`Data: ${new Date().toLocaleDateString()}`, 14, y); y += 12;

  pdf.text("Assinatura:", 14, y);
  pdf.line(40, y, 120, y);

  pdf.save(`Recibo-OS-${os.osnum}.pdf`);
}

window.salvar = salvar;
window.pdfOS = pdfOS;
window.recibo = recibo;

carregar();
</script>

</body>
</html>

